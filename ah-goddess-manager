/*--------------------------------------------------------------
  Awakening Heart : Goddess Manager v2 (No Cloning)
  Version: 2.0 | Date: 2025-11-20
  
  Simplified version that doesn't clone elements.
  Add this BEFORE ah-oracle-scene-v3.1.js
--------------------------------------------------------------*/

(function() {
  'use strict';
  
  console.log('üåô Goddess Manager v2 loaded (no cloning)');
  
  let goddessElement = null;
  
  /**
   * Ensure only one goddess wrapper exists
   */
  function enforceSingleton() {
    const wrappers = Array.from(document.querySelectorAll('#triple-goddess-wrapper'));
    
    if (wrappers.length === 0) {
      console.log('‚è≥ No goddess element found yet');
      return null;
    }
    
    if (wrappers.length > 1) {
      console.warn(`‚ö†Ô∏è Found ${wrappers.length} goddess wrappers, removing duplicates`);
      for (let i = 1; i < wrappers.length; i++) {
        console.log(`üóëÔ∏è Removing duplicate wrapper #${i + 1}`);
        wrappers[i].remove();
      }
    }
    
    // Also check for duplicate SVGs inside wrapper
    const goddess = wrappers[0];
    const svgs = Array.from(goddess.querySelectorAll('svg'));
    
    if (svgs.length > 1) {
      console.warn(`‚ö†Ô∏è Found ${svgs.length} SVGs inside wrapper, removing duplicates`);
      for (let i = 1; i < svgs.length; i++) {
        console.log(`üóëÔ∏è Removing duplicate SVG #${i + 1}`);
        svgs[i].remove();
      }
    }
    
    goddessElement = wrappers[0];
    console.log('‚úÖ Goddess singleton enforced');
    return goddessElement;
  }
  
  /**
   * Make goddess clickable
   */
  function makeGoddessClickable(goddess) {
    if (!goddess) return;
    
    // Force inline styles (highest priority)
    goddess.style.cssText = `
      position: absolute !important;
      z-index: 100 !important;
      pointer-events: auto !important;
      cursor: pointer !important;
    `;
    
    // Also fix SVG inside
    const svg = goddess.querySelector('svg');
    if (svg) {
      svg.style.pointerEvents = 'auto';
      svg.style.cursor = 'pointer';
    }
    
    console.log('‚úÖ Goddess clickable');
  }
  
  /**
   * Attach click handler (no cloning)
   */
  function attachClickHandler(goddess) {
    if (!goddess) return;
    
    console.log('üîó Attaching click handler to goddess');
    
    // Simple click handler - no cloning!
    goddess.addEventListener('click', function goddessClickHandler(e) {
      console.log('üåô GODDESS CLICKED!', {
        x: e.clientX,
        y: e.clientY,
        target: e.target.tagName
      });
      
      e.stopPropagation();
      
      // Visual feedback
      const fullCircle = goddess.querySelector('#full-circle');
      if (fullCircle && window.gsap) {
        gsap.to(fullCircle, {
          scale: 1.15,
          duration: 0.2,
          yoyo: true,
          repeat: 1,
          transformOrigin: '50% 50%',
          ease: 'power2.inOut'
        });
      }
      
      // Call scene controller if available
      if (window.AHSceneController && window.AHSceneController.handleGoddessClick) {
        console.log('‚Üí Calling scene controller handleGoddessClick');
        window.AHSceneController.handleGoddessClick(e);
      } else {
        console.warn('‚ö†Ô∏è Scene controller not found');
      }
    }, { capture: true }); // Use capture to get event early
    
    console.log('‚úÖ Click handler attached');
  }
  
  /**
   * Initialize
   */
  function init() {
    console.log('üåô Initializing Goddess Manager v2');
    
    const goddess = enforceSingleton();
    
    if (goddess) {
      makeGoddessClickable(goddess);
      attachClickHandler(goddess);
    }
    
    // Watch for new goddess elements (but don't interfere with existing ones)
    const observer = new MutationObserver((mutations) => {
      let needsCheck = false;
      
      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (node.nodeType === 1) {
            if (node.id === 'triple-goddess-wrapper' || 
                (node.querySelector && node.querySelector('#triple-goddess-wrapper'))) {
              console.log('üö® New goddess element detected!');
              needsCheck = true;
            }
          }
        });
      });
      
      if (needsCheck) {
        setTimeout(() => {
          enforceSingleton();
        }, 100);
      }
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
    
    console.log('‚úÖ Goddess Manager v2 ready');
  }
  
  // Initialize when DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  
  // Also run after short delays to catch late additions
  setTimeout(init, 500);
  setTimeout(init, 1000);
  
  // Expose API
  window.GoddessManager = {
    enforceSingleton,
    makeGoddessClickable,
    init,
    getGoddess: () => goddessElement
  };
  
  console.log('üí° Manual controls: GoddessManager.enforceSingleton()');
  
})();
